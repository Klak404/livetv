<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Custom Live Admin Channel</title>
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
  <style>
    html, body { 
      margin: 0; padding: 0; height: 100%; background: black; overflow: hidden; 
    }
    #player-hls, #player-yt { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="player-hls"></div>
  <div id="player-yt" class="hidden"></div>

  <script>
    let currentSource = "";
    let currentType = "";
    let hlsPlayer = null;
    let ytPlayer = null;
    let ytApiReady = false;

    // Φόρτωση YouTube IFrame API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = () => { ytApiReady = true; };

    async function checkUpdates() {
      try {
        // Χρήση πλήρους URL για αποφυγή λαθών στη διαδρομή και timestamp για αποφυγή cache
        const response = await fetch('https://klak404.github.io/livetv/test/control.json?v=' + new Date().getTime());
        
        if (!response.ok) throw new Error("JSON not found");
        
        const data = await response.json();
        console.log("Checking... Current in JSON:", data.currentSource);

        // Αν η πηγή ή ο τύπος άλλαξε στο control.json
        if (data.currentSource !== currentSource || data.type !== currentType) {
          console.log("New content detected! Switching to:", data.currentSource);
          currentSource = data.currentSource;
          currentType = data.type;
          renderPlayer(data);
        }
      } catch (e) {
        console.error("Update error:", e);
      }
    }

    function renderPlayer(data) {
      // Καθαρισμός και απόκρυψη προηγούμενων players
      document.getElementById('player-hls').classList.add('hidden');
      document.getElementById('player-yt').classList.add('hidden');
      if (hlsPlayer) { hlsPlayer.destroy(); hlsPlayer = null; }
      if (ytPlayer) { document.getElementById('player-yt').innerHTML = ""; ytPlayer = null; }

      if (data.type === "hls") {
        document.getElementById('player-hls').classList.remove('hidden');
        hlsPlayer = new Clappr.Player({
          source: data.currentSource,
          parentId: "#player-hls",
          autoPlay: true,
          mute: false,
          width: "100%",
          height: "100%"
        });
      } 
      else if (data.type === "youtube" && ytApiReady) {
        document.getElementById('player-yt').classList.remove('hidden');
        ytPlayer = new YT.Player('player-yt', {
          videoId: data.currentSource,
          playerVars: { 
            autoplay: 1, 
            controls: 1, 
            rel: 0, 
            modestbranding: 1 
          }
        });
      }
    }

    // Έλεγχος για αλλαγές κάθε 10 δευτερόλεπτα
    setInterval(checkUpdates, 10000);
    checkUpdates();
  </script>

  <script src="../controls.js"></script>

</body>
</html>
